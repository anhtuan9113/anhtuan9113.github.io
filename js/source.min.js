var CloudPlayer=angular.module("cloudPlayer",["ui.bootstrap","SafeApply","ngDialog","ngAnimate"],["$interpolateProvider",function(a){a.startSymbol("[{"),a.endSymbol("}]")}]);CloudPlayer.controller("FileListCtrl",["$scope","$modal","$http","ngDialog",function(a,b,c,d){a.files=[],a.player={isMaximized:!1},a.pageTokens=[],a.currentPage=-1;var e="(mimeType contains 'audio/mpeg' or mimeType contains 'video')",f="http://api.musixmatch.com/ws/1.1/",g="f32f23bbc65313bc4b0a8e45dc87a555";a.login=function(b,c){var d=!b;return c&&"drive"!=c?c&&alert("This feature is coming soon !! Sorry for this inconvenience!."):gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:d},function(b){b&&!b.error?(gapi.client.load("drive","v2",function(){a.$watch("keyword",function(b){var c=e;b&&b.length>2&&(c+=" and fullText contains '"+b+"'"),a.currentPage=-1,a.loadFileList({q:c})})}),gapi.client.load("plus","v1",function(){a.loadProfile()}),gapi.client.load("youtube","v3"),a.loginPoup&&a.loginPoup.close()):a.showLoginPopup()}),d},a.logout=function(){c.get("https://accounts.google.com/o/oauth2/revoke?token="+gapi.auth.getToken().access_token).then(function(a){location.reload()},function(a){location.reload()})},a.loadProfile=function(){var b=gapi.client.plus.people.get({userId:"me"});b.execute(function(b){a.profile=b,a.$safeApply()})},a.loadFileList=function(b){var c={q:e,maxResults:50};for(var d in b)c[d]=b[d];var f=gapi.client.drive.files.list(c);f.execute(function(b){a.files=b.items,a.files.forEach(function(a){a.createdDate=moment(a.createdDate).format("YYYY-MM-DD")}),b.nextPageToken&&a.pageTokens.indexOf(b.nextPageToken)<0&&(a.pageTokens.push(b.nextPageToken),a.nextPageToken=b.nextPageToken),a.haveNextPage=!(!b.nextPageToken||0==a.files.length),a.$safeApply()})},a.nextPage=function(){var b=a.pageTokens[++a.currentPage];a.loadFileList({pageToken:b})},a.previousPage=function(){var b=a.pageTokens[--a.currentPage];a.loadFileList({pageToken:b})},a.showLoginPopup=function(){a.loginPoup=d.open({showClose:!1,closeByEscape:!1,closeByDocument:!1,template:"templates/LoginPopup.html",scope:a})},a.play=function(b,c){var d=b.downloadUrl;if(!d)return alert("Url is undefined");var e=gapi.auth.getToken().access_token;player.src({type:b.title.indexOf("mp3")>0?"audio/mpeg":"video/mp4",src:d+"&access_token="+e}),setTimeout(function(){player.paused()&&player.play()},1e3),player.play(),a.currentFile=b,a.files.forEach(function(a){a.isPlaying=!1}),b.isPlaying=!0,a.updatePlayerState(),a.$safeApply(),b.mimeType.indexOf("video")>=0&&!a.player.isMaximized&&!c&&a.togglePlayer(),b.cover?player.poster(b.cover):a.getFileImage(b,function(){b.mimeType.indexOf("audio")>=0?(player.poster(b.cover),$(player.el()).find(".vjs-poster").show()):(player.poster(""),$(player.el()).find(".vjs-poster").hide())})},a.getFileImage=function(b,c){var d=b.title.slice(0,b.title.lastIndexOf("."));$.ajax({type:"GET",data:{apikey:g,q:d,format:"jsonp",callback:"jsonp_callback"},url:f+"track.search",dataType:"jsonp",jsonpCallback:"jsonp_callback",contentType:"application/json",success:function(e){var f=e.message.header,g=e.message.body,h=null,i=null;200==f.status_code&&f.available>0&&(g.track_list.forEach(function(a){a=a.track,console.log("Compare %s & %s: %s",d,a.track_name,compare(d,a.track_name)),(null==i||null!=i&&i<compare(d,a.track_name))&&(h=a,i=compare(d,a.track_name))}),b.cover=h.album_coverart_500x500,b.track=h,1==h.has_lyrics&&a.getFileLyric(b)),c&&c()},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},a.getYoutubeMv=function(){var a=gapi.client.youtube.search.list({q:q,part:"snippet"});a.execute(function(a){JSON.stringify(a.result)})},a.getFileLyric=function(b){b.title.slice(0,b.title.lastIndexOf("."));$.ajax({type:"GET",data:{apikey:g,track_id:b.track.track_id,format:"jsonp",callback:"jsonp_lyricCallback"},url:f+"track.lyrics.get",dataType:"jsonp",jsonpCallback:"jsonp_lyricCallback",contentType:"application/json",success:function(c){var d=c.message.header,e=c.message.body;200==d.status_code&&(b.lyric=e.lyrics.lyrics_body.replace("******* This Lyrics is NOT for Commercial use *******",""),a.$safeApply())},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},a.togglePlay=function(b){b.stopPropagation(),player.paused()?player.play():player.pause(),a.updatePlayerState()},a.changePlayerMode=function(b,c,d){b.stopPropagation(),a.player[c]=a.player[c]==d?null:d,a.$safeApply()},a.updatePlayerState=function(){player.currentTime()==player.duration()&&a.currentFile&&player.duration()>0&&(a.nextFile(),player.play()),a.player.state=player.paused()?"paused":"playing",a.$safeApply()},player.on("timeupdate",a.updatePlayerState.bind(a)),a.nextFile=function(b,c){if(c&&c.stopPropagation(),a.currentFile){if(a.player.repeatMode&&"repeat"==a.player.repeatMode)return a.play(a.currentFile,!0);var d=null;a.player.nextFileMode&&"random"==a.player.nextFileMode?d=getRandomInt(0,a.files.length-1):a.files.forEach(function(b,c){b.id==a.currentFile.id&&(d=c)}),d=b?d-1:d+1,0>d&&(d=0),d>=a.files.length&&(d=a.files.length-1),a.play(a.files[d],!0)}},a.togglePlayer=function(){var b=$("body").width();a.player.isMaximized?($("#mainPage").show(),$("#mainPage").animate({left:"0px"},null,null,function(){$("#audio-player").show(500)}),$("#playerBox").animate({right:-b+"px"},null,null,function(){$("#playerBox").hide()})):a.currentFile&&($("#playerBox").show(),$("#audio-player").hide(),$("#mainPage").animate({left:-$("body").width()+"px"},null,null,function(){$("#mainPage").hide()}),$("#playerBox").animate({right:"0px"},null,null,function(){})),a.currentFile&&(a.player.isMaximized=!a.player.isMaximized)};var h=function(b,c){b.preventDefault(),b.stopPropagation(),a.player.isMaximized=!c,a.togglePlayer()};$("#mainPage").swipe({swipeLeft:function(a,b,c,d,e,f){h(a,!0)}}),$("#playerBox").swipe({swipeRight:function(a,b,c,d,e,f){h(a,!1)}}),a.login(),$("#playerBox").css({right:-$("body").width()+"px"}),$("#playerBox").hide()}]);