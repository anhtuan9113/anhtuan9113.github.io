var CloudPlayer=angular.module("cloudPlayer",["ui.bootstrap","SafeApply","ngDialog","ngAnimate"],["$interpolateProvider",function(a){a.startSymbol("[{"),a.endSymbol("}]")}]),player=null;CloudPlayer.run(["$rootScope",function(a){$("body").hide(),a.onPlayerBoxLoaded=function(){player=jwplayer("player"),a.$broadcast("PLAYER_READY"),$("#playerBox").hide(),$("body").show(500,null,function(){$("#playerBox").css({right:-$("body").width()+"px"})})}}]),CloudPlayer.directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(a,b,c){b.replaceWith(b.children())}}}),CloudPlayer.controller("FileListCtrl",["$scope","$modal","$http","ngDialog",function(a,b,c,d){a.files=[],a.player={isMaximized:!1},a.pageTokens=[],a.currentPage=-1;var e="(mimeType contains 'audio/mpeg' or mimeType contains 'video')",f="http://api.musixmatch.com/ws/1.1/",g="f32f23bbc65313bc4b0a8e45dc87a555";a.login=function(b,c){var d=!b;if(c&&"drive"!=c)c&&alert("This feature is coming soon !! Sorry for this inconvenience!.");else{var f=function(b){b&&!b.error?(gapi.client.load("drive","v2",function(){a.$watch("keyword",function(b){var c=e;b&&b.length>2&&(c+=" and fullText contains '"+b+"'"),a.currentPage=-1,a.loadFileList({q:c})})}),gapi.client.load("plus","v1",function(){a.loadProfile()}),gapi.client.load("youtube","v3"),a.loginPoup&&a.loginPoup.close()):a.showLoginPopup()};window.Android&&window.Android.getToken?(console.log(Android.getToken()),gapi.auth.setToken({access_token:Android.getToken()}),console.log(gapi.auth.getToken().access_token),f({})):gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:d},f)}return d},a.logout=function(){c.get("https://accounts.google.com/o/oauth2/revoke?token="+gapi.auth.getToken().access_token).then(function(a){location.reload()},function(a){location.reload()})},a.loadProfile=function(){var b=gapi.client.plus.people.get({userId:"me"});b.execute(function(b){a.profile=b,a.$safeApply()})},a.eventStopping=function(a){a&&a.stopPropagation()},a.loadFileList=function(b){var c={q:e,maxResults:50};for(var d in b)c[d]=b[d];var f=gapi.client.drive.files.list(c);f.execute(function(b){a.files=b.items;var c=gapi.auth.getToken().access_token;a.files.forEach(function(a){a.createdDate=moment(a.createdDate).format("YYYY-MM-DD"),a.downloadUrlWithToken=a.downloadUrl+"&access_token="+c}),b.nextPageToken&&a.pageTokens.indexOf(b.nextPageToken)<0&&(a.pageTokens.push(b.nextPageToken),a.nextPageToken=b.nextPageToken),a.haveNextPage=!(!b.nextPageToken||0==a.files.length),a.$safeApply()})},a.nextPage=function(){var b=a.pageTokens[++a.currentPage];a.loadFileList({pageToken:b})},a.previousPage=function(){var b=a.pageTokens[--a.currentPage];a.loadFileList({pageToken:b})},a.showLoginPopup=function(){a.loginPoup=d.open({showClose:!1,closeByEscape:!1,closeByDocument:!1,template:"templates/LoginPopup.html",scope:a})},a.play=function(b,c){var d=b.downloadUrl;if(!d)return alert("Url is undefined");var e=gapi.auth.getToken().access_token;player.setup({file:d+"&access_token="+e,type:b.title.split(".").pop(),width:"100%",height:"400",primary:"html",autostart:!0,androidhls:!0}),a.currentFile=b,a.files.forEach(function(a){a.isPlaying=!1}),b.isPlaying=!0,a.updatePlayerState(),a.$safeApply(),b.mimeType.indexOf("video")>=0&&!a.player.isMaximized&&!c&&a.togglePlayer(),b.cover?$("#player .jw-preview").css({"background-image":"url("+b.cover+")"}):a.getFileImage(b,function(){b.mimeType.indexOf("audio")>=0&&$("#player .jw-preview").css({"background-image":"url("+b.cover+")"})}),a.initPlayerListeners()},a.initPlayerListeners=function(){player.once("time",function(){$(".duration").text(player.getDuration().toString().toHHMMSS()),["#player-bar-big","#player-bar-small"].forEach(function(a){var b=a+" .jp-progress";$(b).click(function(a){a.stopPropagation();var c=player.getDuration()/$(b).width();console.log(c*(a.pageX-$(b).offset().left)/60);var d=c*(a.pageX-$(b).offset().left);player.seek(d)})})});var b=function(){["#player-bar-big","#player-bar-small"].forEach(function(a){$(a+" .currentTime").text(player.getPosition().toString().toHHMMSS()),$(a+" .jp-play-bar").width(100*player.getPosition()/player.getDuration()+"%")}),a.updatePlayerState()};player.on("time",b),player.on("seek",b)},a.getFileImage=function(b,c){var d=b.title.slice(0,b.title.lastIndexOf("."));$.ajax({type:"GET",data:{apikey:g,q:d,format:"jsonp",callback:"jsonp_callback"},url:f+"track.search",dataType:"jsonp",jsonpCallback:"jsonp_callback",contentType:"application/json",success:function(e){var f=e.message.header,g=e.message.body,h=null,i=null;200==f.status_code&&f.available>0&&(g.track_list.forEach(function(a){a=a.track,console.log("Compare %s & %s: %s",d,a.track_name,compare(d,a.track_name)),(null==i||null!=i&&i<compare(d,a.track_name))&&(h=a,i=compare(d,a.track_name))}),b.cover=h.album_coverart_500x500,b.track=h,1==h.has_lyrics&&a.getFileLyric(b)),c&&c()},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},a.getYoutubeMv=function(){var a=gapi.client.youtube.search.list({q:q,part:"snippet"});a.execute(function(a){JSON.stringify(a.result)})},a.getFileLyric=function(b){b.title.slice(0,b.title.lastIndexOf("."));$.ajax({type:"GET",data:{apikey:g,track_id:b.track.track_id,format:"jsonp",callback:"jsonp_lyricCallback"},url:f+"track.lyrics.get",dataType:"jsonp",jsonpCallback:"jsonp_lyricCallback",contentType:"application/json",success:function(c){var d=c.message.header,e=c.message.body;200==d.status_code&&(b.lyric=e.lyrics.lyrics_body.replace("******* This Lyrics is NOT for Commercial use *******",""),a.$safeApply())},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},a.togglePlay=function(b){b.stopPropagation(),a.currentFile&&("paused"==player.getState()||"idle"==player.getState()?player.play():player.pause()),a.updatePlayerState()},a.changePlayerMode=function(b,c,d){b.stopPropagation(),a.player[c]=a.player[c]==d?null:d,a.$safeApply()},a.updatePlayerState=function(){player.getPosition()==player.getDuration()&&a.currentFile&&player.getDuration()>0&&a.nextFile(),a.player.state="paused"==player.getState()||"idle"==player.getState()?"paused":"playing",a.player.volume=player.getVolume(),a.$safeApply()},a.setVolume=function(a,b){b.stopPropagation(),player.setVolume(a)},a.nextFile=function(b,c){if(c&&c.stopPropagation(),a.currentFile){if(a.player.repeatMode&&"repeat"==a.player.repeatMode)return a.play(a.currentFile,!0);var d=null;a.player.nextFileMode&&"random"==a.player.nextFileMode?d=getRandomInt(0,a.files.length-1):a.files.forEach(function(b,c){b.id==a.currentFile.id&&(d=c)}),d=b?d-1:d+1,0>d&&(d=a.files.length-1),d>=a.files.length&&(d=0),a.play(a.files[d],!0)}},a.togglePlayer=function(){var b=$("body").width();a.player.isMaximized?($("#mainPage").show(),$("#mainPage").css({left:"0px"},null,null,function(){}),$("#audio-player").show(500),$("#playerBox").css({right:-b+"px"},null,null,function(){}),$("#playerBox").hide()):a.currentFile&&($("#playerBox").show(),$("#audio-player").hide(),$("#mainPage").css({left:-$("body").width()+"px"},null,null,function(){}),$("#mainPage").hide(),$("#playerBox").css({right:"0px"},null,null,function(){})),a.currentFile&&(a.player.isMaximized=!a.player.isMaximized)};var h=function(b,c){b.preventDefault(),b.stopPropagation(),a.player.isMaximized=!c,a.togglePlayer()};a.login(),a.$on("PLAYER_READY",function(){$("#mainPage").swipe({swipeLeft:function(a,b,c,d,e,f){h(a,!0)}}),$("#playerBox").swipe({swipeRight:function(a,b,c,d,e,f){h(a,!1)}})})}]);