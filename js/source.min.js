var CloudPlayer=angular.module("cloudPlayer",["ui.bootstrap","SafeApply"],["$interpolateProvider",function(a){a.startSymbol("[{"),a.endSymbol("}]")}]);CloudPlayer.controller("FileListCtrl",["$scope","$modal","$http",function(a,b,c){a.files=[],a.player={isMaximized:!1};var d="http://api.musixmatch.com/ws/1.1/";a.login=function(b,c){var d=!b;return c&&"drive"!=c?c&&alert("This feature is coming soon !! Sorry for this inconvenience!."):gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:d},function(b){b&&!b.error?(gapi.client.load("drive","v2",function(){a.loadFileList()}),gapi.client.load("plus","v1",function(){a.loadProfile()}),gapi.client.load("youtube","v3"),a.modalInstance&&a.modalInstance.close()):a.showLoginPopup()}),d},a.logout=function(){c.get("https://accounts.google.com/o/oauth2/revoke?token="+gapi.auth.getToken().access_token).then(function(a){location.reload()},function(a){location.reload()})},a.loadProfile=function(){var b=gapi.client.plus.people.get({userId:"me"});b.execute(function(b){a.profile=b,a.$safeApply()})},a.loadFileList=function(){var b=gapi.client.drive.files.list({q:"mimeType contains 'audio/mpeg' or mimeType contains 'video'"});b.execute(function(b){a.files=b.items,a.files.forEach(function(a){a.createdDate=moment(a.createdDate).format("YYYY-MM-DD")}),a.$safeApply()})},a.showLoginPopup=function(){a.modalInstance=b.open({animation:!0,backdrop:"static",keyboard:!1,scope:a,templateUrl:"templates/LoginPopup.html"})},a.play=function(b,c){var d=b.downloadUrl;if(!d)return alert("Url is undefined");var e=gapi.auth.getToken().access_token;player.src({type:b.title.indexOf("mp3")>0?"audio/mpeg":"video/mp4",src:d+"&access_token="+e}),player.play(),a.currentFile=b,a.files.forEach(function(a){a.isPlaying=!1}),b.isPlaying=!0,a.updatePlayerState(),a.$safeApply(),b.mimeType.indexOf("video")>=0&&!a.player.isMaximized&&!c&&a.togglePlayer(),b.cover?player.poster(b.cover):a.getFileImage(b,function(){b.mimeType.indexOf("audio")>=0?(player.poster(b.cover),$(player.el()).find(".vjs-poster").show()):(player.poster(""),$(player.el()).find(".vjs-poster").hide())})},a.getFileImage=function(b,c){var e=b.title.slice(0,b.title.lastIndexOf("."));$.ajax({type:"GET",data:{apikey:"ce10b72197aa016d84684605bcaccda6",q:e,format:"jsonp",callback:"jsonp_callback"},url:d+"track.search",dataType:"jsonp",jsonpCallback:"jsonp_callback",contentType:"application/json",success:function(d){var f=d.message.header,g=d.message.body,h=null,i=null;200==f.status_code&&f.available>0&&(g.track_list.forEach(function(a){a=a.track,console.log("Compare %s & %s: %s",e,a.track_name,compare(e,a.track_name)),(null==i||null!=i&&i<compare(e,a.track_name))&&(h=a,i=compare(e,a.track_name))}),b.cover=h.album_coverart_500x500,b.track=h,1==h.has_lyrics&&a.getFileLyric(b)),c&&c()},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},a.getFileLyric=function(b){b.title.slice(0,b.title.lastIndexOf("."));$.ajax({type:"GET",data:{apikey:"ce10b72197aa016d84684605bcaccda6",track_id:b.track.track_id,format:"jsonp",callback:"jsonp_callback"},url:d+"track.lyrics.get",dataType:"jsonp",jsonpCallback:"jsonp_callback",contentType:"application/json",success:function(c){var d=c.message.header,e=c.message.body;200==d.status_code&&(b.lyric=e.lyrics.lyrics_body.replace("******* This Lyrics is NOT for Commercial use *******",""),a.$safeApply())},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},a.togglePlay=function(b){b.stopPropagation(),player.paused()?player.play():player.pause(),a.updatePlayerState()},a.updatePlayerState=function(){a.player.state=player.paused()?"paused":"playing",a.$safeApply()},player.on("timeupdate",a.updatePlayerState.bind(a)),a.nextFile=function(b,c){c.stopPropagation();var d=null;a.files.forEach(function(b,c){b.id==a.currentFile.id&&(d=c)}),d=b?d-1:d+1,0>d&&(d=0),a.play(a.files[d],!0)},a.togglePlayer=function(){var b=$("body").width();a.player.isMaximized?($("#mainPage").show(),$("#mainPage").animate({left:"0px"},null,null,function(){$("#audio-player").show(500)}),$("#playerBox").animate({right:-b+"px"},null,null,function(){$("#playerBox").hide()})):a.currentFile&&($("#playerBox").show(),$("#audio-player").hide(),$("#mainPage").animate({left:-$("body").width()+"px"},null,null,function(){$("#mainPage").hide()}),$("#playerBox").animate({right:"0px"},null,null,function(){})),a.player.isMaximized=!a.player.isMaximized},$("#mainPage").on("swipeleft",function(){a.player.isMaximized=!1,a.togglePlayer()}),$("#playerBox").on("swiperight",function(){a.player.isMaximized=!0,a.togglePlayer()}),a.login(),$("#playerBox").css({right:-$("body").width()+"px"}),$("#playerBox").hide()}]);